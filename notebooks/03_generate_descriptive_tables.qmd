---
title: "Generate Descriptive Tables"
author: "Brennan Hickson"
format: html
editor: visual
---

# Install and Load Libraries

```{r Initial Setup and Library Loading, echo=TRUE, eval=FALSE}
# Load the pacman package (install if necessary)
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

# Install and load prerequisite libraries
pacman::p_load(extrafont, gt, gtsummary, here, tidyverse)

# Create the 'data/processed' subdirectory if not already accessible
data_processed_dir <- here("data", "processed")
if (!dir.exists(data_processed_dir)) {
  dir.create(data_processed_dir, recursive = TRUE)
}

# Create the 'output/tables' subdirectory if not already available
output_tables_dir <- here("output", "tables")
if (!dir.exists(output_tables_dir)) {
  dir.create(output_tables_dir, recursive = TRUE)
}

# Import fonts from Font Book
loadfonts(device = "all", quiet = TRUE)

# Set a random seed for reproducibility
set.seed(42)
```

# Prepare Covariate Sets for Table 1

```{r Prepare Covariate Sets of Interest for Table 1}
# Define all covariates of interest
all_proposed_covariates <- c("id",
                             "event_status",
                             "time_to_event_in_years",
                             "time_to_censorship_in_years",
                             "time_to_expiration_in_years",
                             "age_at_censorship",
                             "age_at_expiration",
                             "calendar_year_of_injury",
                             "sex",
                             "age",
                             "education_level_at_injury",
                             "employment_at_injury",
                             "marital_status_at_injury",
                             "rehab_payor_primary_type",
                             "cause_of_injury",
                             "drs_total_at_year_1",
                             "fim_total_at_year_1",
                             "gose_total_at_year_1",
                             "func_score_at_year_1",
                             "mental_health_tx_lifetime_at_injury",
                             "mental_health_tx_past_year_at_injury",
                             "mental_health_tx_hx",
                             "psych_hosp_hx_lifetime_at_injury",
                             "psych_hosp_hx_past_year_at_injury",
                             "psych_hosp_hx",
                             "problematic_substance_use_at_injury", 
                             "problematic_substance_use_at_year_1",
                             "suicide_attempt_hx_lifetime_at_injury", 
                             "suicide_attempt_hx_past_year_at_injury",
                             "suicide_attempt_hx_past_year_at_year_1",
                             "suicide_attempt_hx",
                             "depression_level_at_year_1")

# Define select covariates of interest (remove individual function scores and mental health history variable components)
select_covariates_1 <- c("id",
                         "event_status",
                         "time_to_event_in_years",
                         "time_to_censorship_in_years",
                         "time_to_expiration_in_years",
                         "age_at_censorship",
                         "age_at_expiration",
                         "calendar_year_of_injury",
                         "sex",
                         "age",
                         "education_level_at_injury",
                         "employment_at_injury",
                         "marital_status_at_injury",
                         "rehab_payor_primary_type",
                         "cause_of_injury",
                         "func_score_at_year_1",
                         "mental_health_tx_hx",
                         "psych_hosp_hx",
                         "problematic_substance_use_at_injury",
                         "problematic_substance_use_at_year_1",
                         "suicide_attempt_hx",
                         "depression_level_at_year_1")

analytic_data_for_tables_all <- analytic_data_final |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, "Missing")) |>
  select("id", all_of(all_proposed_covariates)) |>
  arrange(id)

analytic_data_for_tables_select_1 <- analytic_data_final |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, "Missing")) |>
  select("id", all_of(select_covariates_1)) |>
  arrange(id)
```

```{r Create complete-case and incomplete-case subsamples}
# Select the variables to exclude from the complete case data frame
variables_to_exclude <- c("time_to_censorship_in_years",
                          "time_to_expiration_in_years", 
                          "age_at_censorship",
                          "age_at_expiration")

# Adjust the dataset to exclude specified variables for evaluation of missingness among model covariates
variables_for_cc_all <- setdiff(all_proposed_covariates, variables_to_exclude)
variables_for_cc_select_1 <- setdiff(select_covariates_1, variables_to_exclude)

# Prepare the complete cases data frame
analytic_data_for_cc_all <- analytic_data_final |>
  select(id, all_of(variables_for_cc_all)) |>
  arrange(id)

analytic_data_for_cc_select_1 <- analytic_data_final |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, "Missing")) |>
  select(id, all_of(variables_for_cc_select_1)) |>
  arrange(id)

# Create a new data frame with only complete cases
complete_cases_all <- analytic_data_for_cc_all[complete.cases(analytic_data_for_cc_all), ]
complete_cases_select_1 <- analytic_data_for_cc_select_1[complete.cases(analytic_data_for_cc_select_1), ]

# Create a new data frame with only complete cases for tables
complete_cases_for_tables_all <- complete_cases_all |>
  left_join(analytic_data_final |>
              select(id, time_to_censorship_in_years, time_to_expiration_in_years, age_at_censorship, age_at_expiration), by = "id") |>
  select(names(complete_cases_all)[1:3],  # Retain the first three variables, up to 'time_to_event_in_years'
         time_to_censorship_in_years,
         time_to_expiration_in_years,
         age_at_censorship,
         age_at_expiration,
         names(complete_cases_all)[-c(1:3)])  # Add the remaining the variables from 'complete_cases_all', excluding the first three

# Save the 'complete_cases_all' data frame in a single .rds file
saveRDS(complete_cases_all, here(data_processed_dir, "complete_cases.rds"))

# Save the 'complete_cases_all' data frame as a CSV file in the 'data/processed' subdirectory
write.csv(complete_cases_all, file.path(data_processed_dir, "complete_cases_all.csv"), row.names = FALSE)
```

```{r}
# Create a new data frame with only incomplete cases
incomplete_cases_all <- analytic_data_for_cc_all[!complete.cases(analytic_data_for_cc_all), ]
incomplete_cases_select_1 <- analytic_data_for_cc_select_1[!complete.cases(analytic_data_for_cc_select_1), ]
```

```{r include=FALSE}
# Plot the number of missing values across all proposed covariates
all_proposed_covariates_ic_missing_value_counts_plot <- gg_miss_var(incomplete_cases_all) +
  labs(x = "Covariates",
       y = "Number of Missing Values"
  ) +
  scale_x_discrete(
    labels = c(
      age = "Age at Injury",
      sex = "Sex",
      education_level_at_injury = "Educational Attainment at Injury",
      employment_at_injury = "Employment Status at Injury",
      marital_status_at_injury = "Marital Status at Injury",
      rehab_payor_primary = "Primary Rehabilitation Payor",
      rehab_payor_primary_type = "Medicaid Status",
      cause_of_injury = "Mechanism of Injury",
      drs_total_at_year_1 = "DRS Score at Year 1",
      fim_total_at_year_1 = "FIM Score at Year 1",
      gose_total_at_year_1 = "GOS-E Score at Year 1",
      func_score_at_year_1 = "Function Factor Score at Year 1",
      problematic_substance_use_at_injury = "Problematic Substance Use at Injury",
      problematic_substance_use_at_year_1 = "Problematic Substance Use at Year 1",
      suicide_attempt_hx_lifetime_at_injury = "Lifetime History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_injury = "Past-Year History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_year_1 = "Past-Year History of Suicide Attempt at Year 1",
      depression_level_at_year_1 = "Depression Level at Year 1"
    )
  ) +
  scale_y_continuous(labels = label_comma()) +
  theme_classic() +
  customization +
  geom_text(
    data = na_counts_for_all_proposed_covariates,
    aes(x = variable, y = n_missing, label = scales::comma(n_missing)), # Position and format labels
    vjust = -1, # Adjust text position
    hjust = 0.5, # Adjust horizontal position to place text at the end of the bar
    size = 3.25, # Adjust text size
    family = "Proxima Nova"
  )

ggsave(here(missingness_plots_dir, "figure_17-1_all_proposed_covariates_missing_value_counts.png"),
       all_proposed_covariates_missing_value_counts_plot, dpi = 300)
```

```{r}
# Define the custom Fisher's test function for categorical variables
fisher_test_simulate_p_values <- function(data, variable, by, ...) {
  result <- list()
  
  # Run Fisher's Exact Test with simulation and 10,000 replicates
  test_results <- stats::fisher.test(data[[variable]], data[[by]], simulate.p.value = TRUE, B = 10000)
  
  # Store results in a list
  result$p <- test_results$p.value
  result$test <- test_results$method
  result
}
```

```{r Table 1-1-1: Generate descriptive statistics table for the full analytic sample with all proposed covariates}
# Convert calendar year of injury to numeric to treat it as continuous rather than categorical
analytic_data_for_tables_all$calendar_year_of_injury <- as.numeric(analytic_data_for_tables_all$calendar_year_of_injury)

# Generate table with descriptive statistics for the final analytic sample
table_1_1_1 <- analytic_data_for_tables_all |>
  select(-"id") |>
  tbl_summary(
    by = depression_level_at_year_1,
    type = list(calendar_year_of_injury ~ "continuous",
                gose_total_at_year_1 ~ "continuous"),  # Explicitly set calendar year of injury and GOS-E to continuous
    statistic = list(all_continuous() ~ "{median} ({p25}-{p75})",
                     all_categorical() ~ "{n} ({p}%)"),
    digits = list(all_continuous() ~ 2,  # Default for all continuous variables
                  starts_with("calendar") ~ 0,
                  starts_with("age") ~ 0,
                  starts_with("education") ~ 0,
                  starts_with("drs") ~ 1,
                  starts_with("fim") ~ 0,
                  starts_with("gose") ~ 0),
    label = list(
      event_status = "Mortality Events",
      time_to_event_in_years = "Duration of Follow-Up (years)",
      time_to_censorship_in_years = "Time to Censorship (years)",
      time_to_expiration_in_years = "Time to Expiration (years)",
      age_at_censorship = "Age at Censorship (years)",
      age_at_expiration = "Age at Expiration (years)",
      calendar_year_of_injury = "Calendar Year of Injury",
      age = "Age at Injury (years)",
      sex = "Sex",
      education_level_at_injury = "Educational Attainment at Injury",
      employment_at_injury = "Employment Status at Injury",
      marital_status_at_injury = "Marital Status at Injury",
      rehab_payor_primary = "Primary Rehabilitation Payor",
      rehab_payor_primary_type = "Medicaid Status",
      cause_of_injury = "Mechanism of Injury",
      drs_total_at_year_1 = "Total DRS Score at Year 1",
      fim_total_at_year_1 = "Total FIM Score at Year 1",
      gose_total_at_year_1 = "Total GOS-E Score at Year 1",
      func_score_at_year_1 = "Function Factor Score at Year 1",
      mental_health_tx_lifetime_at_injury = "Lifetime History of Mental Health Treatment at Injury",
      mental_health_tx_past_year_at_injury = "Past-Year History of Mental Health Treatment at Injury",
      mental_health_tx_hx = "History of Mental Health Treatment",
      psych_hosp_hx_lifetime_at_injury = "Lifetime History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx_past_year_at_injury = "Past-Year History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx = "History of Psychiatric Hospitalization",
      problematic_substance_use_at_injury = "Problematic Substance Use at Injury",
      problematic_substance_use_at_year_1 = "Problematic Substance Use at Year 1",
      suicide_attempt_hx_lifetime_at_injury = "Lifetime History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_injury = "Past-Year History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_year_1 = "Past-Year History of Suicide Attempt at Year 1",
      suicide_attempt_hx = "History of Suicide Attempt",
      depression_level_at_year_1 = "Depression Level at Year 1"
    )
  ) |>
  add_overall() |>
  bold_labels() |>
  add_p(
    pvalue_fun = ~ style_pvalue(.x, digits = 3),  # Format p-values with 3 decimal places
    # test = list(all_categorical() ~ "fisher_test_simulate_p_values")
  ) |>
  bold_p() |>
  as_gt() |>
  tab_header("Table 1-1-1: Sociodemographic, Functional, and Clinical Characteristics of the Full Analytic Sample with All Proposed Covariates by Depression Level at Year 1") |>
  gtsave(
    filename = here(output_tables_dir, "table_1-1-1_full_analytic_sample_with_all_proposed_covariates.png")
  )
```

```{r Table 1-1-2: Generate descriptive statistics table for the complete-case sample with all proposed covariates}
# Generate table with descriptive statistics for the final analytic sample
table_1_1_2 <- complete_cases_for_tables_all |>
  select(-"id") |>
  tbl_summary(
    by = depression_level_at_year_1,
    type = list(calendar_year_of_injury ~ "continuous",
                gose_total_at_year_1 ~ "continuous"),  # Explicitly set GOS-E to continuous
    statistic = list(all_continuous() ~ "{median} ({p25}-{p75})",
                     all_categorical() ~ "{n} ({p}%)"),
    digits = list(all_continuous() ~ 2,  # Default for all continuous variables
                  starts_with("calendar") ~ 0,
                  starts_with("age") ~ 0,
                  starts_with("education") ~ 0,
                  starts_with("drs") ~ 1,
                  starts_with("fim") ~ 0,
                  starts_with("gose") ~ 0),
    label = list(
      event_status = "Mortality Events",
      time_to_event_in_years = "Duration of Follow-Up (years)",
      time_to_censorship_in_years = "Time to Censorship (years)",
      time_to_expiration_in_years = "Time to Expiration (years)",
      age_at_censorship = "Age at Censorship (years)",
      age_at_expiration = "Age at Expiration (years)",
      calendar_year_of_injury = "Calendar Year of Injury",
      sex = "Sex",
      age = "Age at Injury (years)",
      education_level_at_injury = "Educational Attainment at Injury",
      employment_at_injury = "Employment Status at Injury",
      marital_status_at_injury = "Marital Status at Injury",
      rehab_payor_primary_type = "Medicaid Status",
      cause_of_injury = "Mechanism of Injury",
      drs_total_at_year_1 = "Total DRS Score at Year 1",
      fim_total_at_year_1 = "Total FIM Score at Year 1",
      gose_total_at_year_1 = "Total GOS-E Score at Year 1",
      func_score_at_year_1 = "Function Factor Score at Year 1",
      mental_health_tx_lifetime_at_injury = "Lifetime History of Mental Health Treatment at Injury",
      mental_health_tx_past_year_at_injury = "Past-Year History of Mental Health Treatment at Injury",
      mental_health_tx_hx = "History of Mental Health Treatment",
      psych_hosp_hx_lifetime_at_injury = "Lifetime History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx_past_year_at_injury = "Past-Year History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx = "History of Psychiatric Hospitalization",
      problematic_substance_use_at_injury = "Problematic Substance Use at Injury",
      problematic_substance_use_at_year_1 = "Problematic Substance Use at Year 1",
      suicide_attempt_hx_lifetime_at_injury = "Lifetime History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_injury = "Past-Year History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_year_1 = "Past-Year History of Suicide Attempt at Year 1",
      suicide_attempt_hx = "History of Suicide Attempt",
      depression_level_at_year_1 = "Depression Level at Year 1"
    )
  ) |>
  add_overall() |>
  bold_labels() |>
  add_p(
    pvalue_fun = ~ style_pvalue(.x, digits = 3),  # Format p-values with 3 decimal places
    # test = list(all_categorical() ~ "fisher_test_simulate_p_values")
  ) |>
  bold_p() |>
  as_gt() |>
  tab_header("Table 1-1-2: Sociodemographic, Functional, and Clinical Characteristics of the Complete-Case Sample with All Proposed Covariates by Depression Level at Year 1") |>
  gtsave(
    filename = here(output_tables_dir, "table_1-1-2_complete_case_sample_with_all_proposed_covariates.png")
  )
```