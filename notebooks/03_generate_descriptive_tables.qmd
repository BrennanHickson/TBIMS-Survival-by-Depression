---
title: "Generate Descriptive Tables"
author: "Brennan Hickson"
format: html
editor: visual
---

# Install and Load Libraries

```{r Initial Setup and Library Loading, echo = TRUE}
# Load the pacman package (install if necessary)
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

# Install and load prerequisite libraries
pacman::p_load(extrafont, gt, gtsummary, here, naniar, scales, tidyverse)

# Create the 'data/processed' subdirectory if not already accessible
data_processed_dir <- here("data", "processed")
if (!dir.exists(data_processed_dir)) {
  dir.create(data_processed_dir, recursive = TRUE)
}

# Create the 'output/tables' subdirectory if not already available
output_tables_dir <- here("output", "tables")
if (!dir.exists(output_tables_dir)) {
  dir.create(output_tables_dir, recursive = TRUE)
}

# Create the 'output/plots/univariate_and_bivariate_plots' subdirectory if not already available
missingness_plots_dir <- here("output", "plots", "missingness")
if (!dir.exists(missingness_plots_dir)) {
  dir.create(missingness_plots_dir, recursive = TRUE)
}

# Load the .rds files
analytic_data_final <- readRDS(file.path(data_processed_dir, "analytic_data_final.rds"))
na_counts_for_all_proposed_covariates <- readRDS(file.path(data_processed_dir, "na_counts_for_all_proposed_covariates.rds"))
na_counts_for_select_covariates_1 <- readRDS(file.path(data_processed_dir, "na_counts_for_select_covariates_1.rds"))

# Convert 'analytic_data_final' to a data frame
analytic_data_final <- as.data.frame(analytic_data_final)

# Import fonts from Font Book
loadfonts(device = "all", quiet = TRUE)

# Set a random seed for reproducibility
set.seed(42)
```

# Define Custom Preferences

```{r Define a Theme for Customizing Plot Aesthetics}
customization <- theme(
  title = element_text(family = "Proxima Nova", face = "bold", size = 20),
  legend.title = element_text(family = "Proxima Nova", face = "bold", size = 10),
  legend.text = element_text(family = "Proxima Nova", size = 9.5),
  axis.title.x = element_text(family = "Proxima Nova", face = "bold", size = 12, margin = margin(t = 10)),
  axis.title.y = element_text(family = "Proxima Nova", face = "bold", size = 12, margin = margin(r = 10)),
  axis.text = element_text(family = "Proxima Nova", size = 10),
  text = element_text(family = "Proxima Nova"),
  legend.position = "top"
)
```

# Import the Data

```{r Import the Data}
# Define the column classes
column_classes <- c(
  "id" = "integer",
  "event_status" = "factor",
  "time_to_event_in_years" = "numeric",
  "time_to_censorship_in_years" = "numeric",
  "time_to_expiration_in_years" = "numeric",
  "age_at_censorship" = "numeric",
  "age_at_expiration" = "numeric",
  "calendar_year_of_injury" = "integer",
  "sex" = "factor",
  "age_at_injury" = "integer",
  "education_level_at_injury" = "numeric",
  "employment_at_injury" = "factor",
  "marital_status_at_injury" = "factor",
  "rehab_payor_primary" = "factor",
  "rehab_payor_primary_type" = "factor",
  "cause_of_injury" = "factor",
  "drs_total_at_year_1" = "numeric",
  "fim_total_at_year_1" = "numeric",
  "gose_total_at_year_1" = "numeric",
  "func_score_at_year_1" = "numeric",
  "mental_health_tx_lifetime_at_injury" = "factor",
  "mental_health_tx_past_year_at_injury" = "factor",
  "mental_health_tx_hx" = "factor",
  "psych_hosp_hx_lifetime_at_injury" = "factor",
  "psych_hosp_hx_past_year_at_injury" = "factor",
  "psych_hosp_hx" = "factor",
  "problematic_substance_use_at_injury" = "factor",
  "problematic_substance_use_at_year_1" = "factor",
  "suicide_attempt_hx_lifetime_at_injury" = "factor",
  "suicide_attempt_hx_past_year_at_injury" = "factor",
  "suicide_attempt_hx_past_year_at_year_1" = "factor",
  "suicide_attempt_hx" = "factor",
  "depression_level_at_year_1" = "factor"
)

# Ensure analytic_data_final is a data frame
analytic_data_final <- as.data.frame(analytic_data_final)

# Convert columns to their proper types
for (col in names(column_classes)) {
  class_type <- column_classes[[col]]
  analytic_data_final[[col]] <- switch(class_type,
                                       "integer" = as.integer(analytic_data_final[[col]]),
                                       "numeric" = as.numeric(analytic_data_final[[col]]),
                                       "factor" = as.factor(analytic_data_final[[col]]),
                                       analytic_data_final[[col]])
}
```

# Prepare Covariate Sets for Table 1

```{r Prepare Covariate Sets of Interest for Table 1}
# Define all covariates of interest
all_proposed_covariates <- c("id",
                             "event_status",
                             "time_to_event_in_years",
                             "time_to_censorship_in_years",
                             "time_to_expiration_in_years",
                             "age_at_censorship",
                             "age_at_expiration",
                             "calendar_year_of_injury",
                             "sex",
                             "age_at_injury",
                             "education_level_at_injury",
                             "employment_at_injury",
                             "marital_status_at_injury",
                             "rehab_payor_primary",
                             "rehab_payor_primary_type",
                             "cause_of_injury",
                             "drs_total_at_year_1",
                             "fim_total_at_year_1",
                             "gose_total_at_year_1",
                             "func_score_at_year_1",
                             "mental_health_tx_lifetime_at_injury",
                             "mental_health_tx_past_year_at_injury",
                             "mental_health_tx_hx",
                             "psych_hosp_hx_lifetime_at_injury",
                             "psych_hosp_hx_past_year_at_injury",
                             "psych_hosp_hx",
                             "problematic_substance_use_at_injury", 
                             "problematic_substance_use_at_year_1",
                             "suicide_attempt_hx_lifetime_at_injury", 
                             "suicide_attempt_hx_past_year_at_injury",
                             "suicide_attempt_hx_past_year_at_year_1",
                             "suicide_attempt_hx",
                             "depression_level_at_year_1")

# Define select covariates of interest (remove individual function scores and mental health history variable components)
select_covariates_1 <- c("id",
                         "event_status",
                         "time_to_event_in_years",
                         "time_to_censorship_in_years",
                         "time_to_expiration_in_years",
                         "age_at_censorship",
                         "age_at_expiration",
                         "calendar_year_of_injury",
                         "sex",
                         "age_at_injury",
                         "education_level_at_injury",
                         "employment_at_injury",
                         "marital_status_at_injury",
                         "rehab_payor_primary",
                         "rehab_payor_primary_type",
                         "cause_of_injury",
                         "func_score_at_year_1",
                         "mental_health_tx_hx",
                         "psych_hosp_hx",
                         "problematic_substance_use_at_injury",
                         "problematic_substance_use_at_year_1",
                         "suicide_attempt_hx",
                         "depression_level_at_year_1")

analytic_data_for_tables_all <- analytic_data_final |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, "Missing")) |>
  select("id", all_of(all_proposed_covariates)) |>
  arrange(id)

analytic_data_for_tables_select_1 <- analytic_data_final |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, "Missing")) |>
  select("id", all_of(select_covariates_1)) |>
  arrange(id)
```

```{r}
# Adjust the levels of the factor variables
analytic_data_for_tables_all <- analytic_data_for_tables_all |>
  mutate(
    depression_level_at_year_1 = factor(depression_level_at_year_1,
                                        levels = c("No Depression",
                                                   "Minor Depression",
                                                   "Major Depression")),
    mental_health_tx_hx = factor(mental_health_tx_hx,
                                 levels = c("Denied any history of mental health treatment",
                                            "Mental health treatment received prior to year preceding index injury only",
                                            "Mental health treatment received within year preceding index injury")),
    psych_hosp_hx = factor(psych_hosp_hx,
                           levels = c("Denied any history of psychiatric hospitalization",
                                      "Psychiatric hospital admission prior to year preceding index injury only",
                                      "Psychiatric hospital admission within year preceding index injury")),
    suicide_attempt_hx = factor(suicide_attempt_hx, 
                                levels = c("Denied any history of suicide attempt", 
                                           "Suicide attempt history prior to injury", 
                                           "Suicide attempt in the first year post-injury")),
    sex = factor(sex, 
                 levels = c("Male", "Female")),
    employment_at_injury = factor(employment_at_injury, 
                                  levels = c("Competitively Employed", 
                                             "Unemployed", 
                                             "Student", 
                                             "Retired", 
                                             "Other")),
    marital_status_at_injury = factor(marital_status_at_injury,
                                      levels = c("Single",
                                                 "Married",
                                                 "Divorced",
                                                 "Other")),
    rehab_payor_primary_type = factor(rehab_payor_primary_type, 
                                      levels = c("Non-Medicaid", "Medicaid")),
    cause_of_injury = factor(cause_of_injury,
                             levels = c("Vehicular",
                                        "Falls",
                                        "Violence",
                                        "Other")),
    problematic_substance_use_at_injury = factor(problematic_substance_use_at_injury,
                                                 levels = c("No",
                                                            "Yes")),
    problematic_substance_use_at_year_1 = factor(problematic_substance_use_at_year_1,
                                                 levels = c("No",
                                                            "Yes"))
  )

analytic_data_for_tables_select_1 <- analytic_data_for_tables_select_1 |>
  mutate(
    depression_level_at_year_1 = factor(depression_level_at_year_1,
                                        levels = c("No Depression",
                                                   "Minor Depression",
                                                   "Major Depression")),
    mental_health_tx_hx = factor(mental_health_tx_hx,
                                 levels = c("Denied any history of mental health treatment",
                                            "Mental health treatment received prior to year preceding index injury only",
                                            "Mental health treatment received within year preceding index injury")),
    psych_hosp_hx = factor(psych_hosp_hx,
                           levels = c("Denied any history of psychiatric hospitalization",
                                      "Psychiatric hospital admission prior to year preceding index injury only",
                                      "Psychiatric hospital admission within year preceding index injury")),
    suicide_attempt_hx = factor(suicide_attempt_hx, 
                                levels = c("Denied any history of suicide attempt", 
                                           "Suicide attempt history prior to injury", 
                                           "Suicide attempt in the first year post-injury")),
    sex = factor(sex, 
                 levels = c("Male", "Female")),
    employment_at_injury = factor(employment_at_injury, 
                                  levels = c("Competitively Employed", 
                                             "Unemployed", 
                                             "Student", 
                                             "Retired", 
                                             "Other")),
    marital_status_at_injury = factor(marital_status_at_injury,
                                      levels = c("Single",
                                                 "Married",
                                                 "Divorced",
                                                 "Other")),
    rehab_payor_primary_type = factor(rehab_payor_primary_type, 
                                      levels = c("Non-Medicaid", "Medicaid")),
    cause_of_injury = factor(cause_of_injury,
                             levels = c("Vehicular",
                                        "Falls",
                                        "Violence",
                                        "Other")),
    problematic_substance_use_at_injury = factor(problematic_substance_use_at_injury,
                                                 levels = c("No",
                                                            "Yes")),
    problematic_substance_use_at_year_1 = factor(problematic_substance_use_at_year_1,
                                                 levels = c("No",
                                                            "Yes"))
  )
```

```{r Create complete-case and incomplete-case subsamples}
# Select the variables to exclude from the complete case data frame
variables_to_exclude <- c("time_to_censorship_in_years",
                          "time_to_expiration_in_years", 
                          "age_at_censorship",
                          "age_at_expiration")

# Adjust the dataset to exclude specified variables for evaluation of missingness among model covariates
variables_for_cc_all <- setdiff(all_proposed_covariates, variables_to_exclude)
variables_for_cc_select_1 <- setdiff(select_covariates_1, variables_to_exclude)

# Prepare the complete cases data frame
analytic_data_for_cc_all <- analytic_data_final |>
  select(id, all_of(variables_for_cc_all)) |>
  arrange(id)

analytic_data_for_cc_select_1 <- analytic_data_final |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, "Missing")) |>
  select(id, all_of(variables_for_cc_select_1)) |>
  arrange(id)

# Create a new data frame with only complete cases
complete_cases_all <- analytic_data_for_cc_all[complete.cases(analytic_data_for_cc_all), ]
complete_cases_select_1 <- analytic_data_for_cc_select_1[complete.cases(analytic_data_for_cc_select_1), ]

# Create a new data frame with only complete cases for tables
complete_cases_for_tables_all <- complete_cases_all |>
  left_join(analytic_data_final |>
              select(id, time_to_censorship_in_years, time_to_expiration_in_years, age_at_censorship, age_at_expiration), by = "id") |>
  select(names(complete_cases_all)[1:3],  # Retain the first three variables, up to 'time_to_event_in_years'
         time_to_censorship_in_years,
         time_to_expiration_in_years,
         age_at_censorship,
         age_at_expiration,
         names(complete_cases_all)[-c(1:3)])  # Add the remaining the variables from 'complete_cases_all', excluding the first three

# Prepare the levels of depression level at year 1
complete_cases_for_tables_all <- complete_cases_for_tables_all |>
  mutate(
    depression_level_at_year_1 = factor(depression_level_at_year_1,
                                        levels = c("No Depression",
                                                   "Minor Depression",
                                                   "Major Depression")),
    mental_health_tx_hx = factor(mental_health_tx_hx,
                                 levels = c("Denied any history of mental health treatment",
                                            "Mental health treatment received prior to year preceding index injury only",
                                            "Mental health treatment received within year preceding index injury")),
    psych_hosp_hx = factor(psych_hosp_hx,
                           levels = c("Denied any history of psychiatric hospitalization",
                                      "Psychiatric hospital admission prior to year preceding index injury only",
                                      "Psychiatric hospital admission within year preceding index injury")),
    suicide_attempt_hx = factor(suicide_attempt_hx, 
                                levels = c("Denied any history of suicide attempt", 
                                           "Suicide attempt history prior to injury", 
                                           "Suicide attempt in the first year post-injury")),
    sex = factor(sex, 
                 levels = c("Male", "Female")),
    employment_at_injury = factor(employment_at_injury, 
                                  levels = c("Competitively Employed", 
                                             "Unemployed", 
                                             "Student", 
                                             "Retired", 
                                             "Other")),
    marital_status_at_injury = factor(marital_status_at_injury,
                                      levels = c("Single",
                                                 "Married",
                                                 "Divorced",
                                                 "Other")),
    rehab_payor_primary_type = factor(rehab_payor_primary_type, 
                                      levels = c("Non-Medicaid", "Medicaid")),
    cause_of_injury = factor(cause_of_injury,
                             levels = c("Vehicular",
                                        "Falls",
                                        "Violence",
                                        "Other")),
    problematic_substance_use_at_injury = factor(problematic_substance_use_at_injury,
                                                 levels = c("No",
                                                            "Yes")),
    problematic_substance_use_at_year_1 = factor(problematic_substance_use_at_year_1,
                                                 levels = c("No",
                                                            "Yes"))
  )

# Save the 'complete_cases_all' data frame in a single .rds file
saveRDS(complete_cases_all, here(data_processed_dir, "complete_cases_all.rds"))

# Save the 'complete_cases_all' data frame as a CSV file in the 'data/processed' subdirectory
write.csv(complete_cases_all, file.path(data_processed_dir, "complete_cases_all.csv"), row.names = FALSE)
```

```{r}
# Create a new data frame with only incomplete cases
incomplete_cases_all <- analytic_data_for_cc_all[!complete.cases(analytic_data_for_cc_all), ]
incomplete_cases_select_1 <- analytic_data_for_cc_select_1[!complete.cases(analytic_data_for_cc_select_1), ]
```

```{r Table 1-1-1: Generate descriptive statistics table for the full analytic sample with all proposed covariates}
# Convert calendar year of injury to numeric to treat it as continuous rather than categorical
analytic_data_for_tables_all$calendar_year_of_injury <- as.numeric(analytic_data_for_tables_all$calendar_year_of_injury)
analytic_data_for_tables_all$gose_total_at_year_1 <- as.numeric(analytic_data_for_tables_all$gose_total_at_year_1)

# Handle missing values in depression_level_at_year_1
analytic_data_for_tables_all <- analytic_data_for_tables_all |>
  mutate(depression_level_at_year_1 = fct_na_value_to_level(depression_level_at_year_1, level = "Missing"))

# Generate table with descriptive statistics for the final analytic sample
table_1_1_1 <- analytic_data_for_tables_all |>
  select(-"id") |>
  tbl_summary(
    by = depression_level_at_year_1,
    type = list(calendar_year_of_injury ~ "continuous",
                gose_total_at_year_1 ~ "continuous"),  # Explicitly set calendar year of injury and GOS-E to continuous
    statistic = list(all_continuous() ~ "{median} ({p25}-{p75})",
                     all_categorical() ~ "{n} ({p}%)"),
    digits = list(all_continuous() ~ 2,  # Default for all continuous variables
                  starts_with("calendar") ~ 0,
                  starts_with("age") ~ 0,
                  starts_with("education") ~ 0,
                  starts_with("drs") ~ 1,
                  starts_with("fim") ~ 0,
                  starts_with("gose") ~ 0),
    label = list(
      event_status = "Mortality Events",
      time_to_event_in_years = "Duration of Follow-Up (years)",
      time_to_censorship_in_years = "Time to Censorship (years)",
      time_to_expiration_in_years = "Time to Expiration (years)",
      age_at_censorship = "Age at Censorship (years)",
      age_at_expiration = "Age at Expiration (years)",
      calendar_year_of_injury = "Calendar Year of Injury",
      age_at_injury = "Age at Injury (years)",
      sex = "Sex",
      education_level_at_injury = "Educational Attainment at Injury",
      employment_at_injury = "Employment Status at Injury",
      marital_status_at_injury = "Marital Status at Injury",
      rehab_payor_primary = "Primary Rehabilitation Payor",
      rehab_payor_primary_type = "Medicaid Status",
      cause_of_injury = "Mechanism of Injury",
      drs_total_at_year_1 = "Total DRS Score at Year 1",
      fim_total_at_year_1 = "Total FIM Score at Year 1",
      gose_total_at_year_1 = "Total GOS-E Score at Year 1",
      func_score_at_year_1 = "Function Factor Score at Year 1",
      mental_health_tx_lifetime_at_injury = "Lifetime History of Mental Health Treatment at Injury",
      mental_health_tx_past_year_at_injury = "Past-Year History of Mental Health Treatment at Injury",
      mental_health_tx_hx = "History of Mental Health Treatment",
      psych_hosp_hx_lifetime_at_injury = "Lifetime History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx_past_year_at_injury = "Past-Year History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx = "History of Psychiatric Hospitalization",
      problematic_substance_use_at_injury = "Problematic Substance Use at Injury",
      problematic_substance_use_at_year_1 = "Problematic Substance Use at Year 1",
      suicide_attempt_hx_lifetime_at_injury = "Lifetime History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_injury = "Past-Year History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_year_1 = "Past-Year History of Suicide Attempt at Year 1",
      suicide_attempt_hx = "History of Suicide Attempt",
      depression_level_at_year_1 = "Depression Level at Year 1"
    )
  ) |>
  add_overall() |>
  bold_labels() |>
  add_p(
    pvalue_fun = ~ style_pvalue(.x, digits = 3),  # Format p-values with 3 decimal places
    # test = list(all_categorical() ~ "fisher_test_simulate_p_values")
  ) |>
  bold_p() |>
  as_gt() |>
  tab_header("Table 1-1-1: Sociodemographic, Functional, and Clinical Characteristics of the Full Analytic Sample with All Proposed Covariates by Depression Level at Year 1") |>
  gtsave(
    filename = here(output_tables_dir, "table_1-1-1_full_analytic_sample_with_all_proposed_covariates_5-year_followup.png")
  )
```

![](images/table_1-1-1_full_analytic_sample_with_all_proposed_covariates.png){fig-align="center"}

```{r Table 1-1-2: Generate descriptive statistics table for the complete-case sample with all proposed covariates}
# # Convert relevant variables to numeric if they are continuous
# complete_cases_for_tables_all$calendar_year_of_injury <- as.numeric(complete_cases_for_tables_all$calendar_year_of_injury)
# complete_cases_for_tables_all$gose_total_at_year_1 <- as.numeric(complete_cases_for_tables_all$gose_total_at_year_1)
# complete_cases_for_tables_all$education_level_at_injury <- as.numeric(complete_cases_for_tables_all$education_level_at_injury)

# Generate table with descriptive statistics for the final analytic sample
table_1_1_2 <- complete_cases_for_tables_all |>
  select(-"id") |>
  tbl_summary(
    by = depression_level_at_year_1,
    type = list(calendar_year_of_injury ~ "continuous",
                gose_total_at_year_1 ~ "continuous",
                education_level_at_injury ~ "continuous"),
    statistic = list(all_continuous() ~ "{median} ({p25}-{p75})",
                     all_categorical() ~ "{n} ({p}%)"),
    digits = list(all_continuous() ~ 2,  # Default for all continuous variables
                  starts_with("calendar") ~ 0,
                  starts_with("age") ~ 0,
                  starts_with("education") ~ 0,
                  starts_with("drs") ~ 1,
                  starts_with("fim") ~ 0,
                  starts_with("gose") ~ 0),
    label = list(
      event_status = "Mortality Events",
      time_to_event_in_years = "Duration of Follow-Up (years)",
      time_to_censorship_in_years = "Time to Censorship (years)",
      time_to_expiration_in_years = "Time to Expiration (years)",
      age_at_censorship = "Age at Censorship (years)",
      age_at_expiration = "Age at Expiration (years)",
      calendar_year_of_injury = "Calendar Year of Injury",
      sex = "Sex",
      age_at_injury = "Age at Injury (years)",
      education_level_at_injury = "Educational Attainment at Injury",
      employment_at_injury = "Employment Status at Injury",
      marital_status_at_injury = "Marital Status at Injury",
      rehab_payor_primary = "Primary Rehabilitation Payor",
      rehab_payor_primary_type = "Medicaid Status",
      cause_of_injury = "Mechanism of Injury",
      drs_total_at_year_1 = "Total DRS Score at Year 1",
      fim_total_at_year_1 = "Total FIM Score at Year 1",
      gose_total_at_year_1 = "Total GOS-E Score at Year 1",
      func_score_at_year_1 = "Function Factor Score at Year 1",
      mental_health_tx_lifetime_at_injury = "Lifetime History of Mental Health Treatment at Injury",
      mental_health_tx_past_year_at_injury = "Past-Year History of Mental Health Treatment at Injury",
      mental_health_tx_hx = "History of Mental Health Treatment",
      psych_hosp_hx_lifetime_at_injury = "Lifetime History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx_past_year_at_injury = "Past-Year History of Psychiatric Hospitalization at Injury",
      psych_hosp_hx = "History of Psychiatric Hospitalization",
      problematic_substance_use_at_injury = "Problematic Substance Use at Injury",
      problematic_substance_use_at_year_1 = "Problematic Substance Use at Year 1",
      suicide_attempt_hx_lifetime_at_injury = "Lifetime History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_injury = "Past-Year History of Suicide Attempt at Injury",
      suicide_attempt_hx_past_year_at_year_1 = "Past-Year History of Suicide Attempt at Year 1",
      suicide_attempt_hx = "History of Suicide Attempt",
      depression_level_at_year_1 = "Depression Level at Year 1"
    )
  ) |>
  add_overall() |>
  bold_labels() |>
  add_p(
    pvalue_fun = ~ style_pvalue(.x, digits = 3),  # Format p-values with 3 decimal places
    # test = list(all_categorical() ~ "fisher_test_simulate_p_values")
  ) |>
  bold_p() |>
  as_gt() |>
  tab_header("Table 1-1-2: Sociodemographic, Functional, and Clinical Characteristics of the Complete-Case Sample with All Proposed Covariates by Depression Level at Year 1") |>
  gtsave(
    filename = here(output_tables_dir, "table_1-1-2_complete_case_sample_with_all_proposed_covariates_5-year_followup.png")
  )
```

![](images/table_1-1-2_complete_case_sample_with_all_proposed_covariates.png){fig-align="center"}
